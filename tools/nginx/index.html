<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta name=description content="命令    Options: -?,-h : this help -v : show version and exit -V : show version and configure options then exit -t : test configuration and exit -T : test configuration, dump it and exit -q : suppress non-error messages during configuration testing -s signal : send signal to a master process: stop, quit, reopen, reload -p prefix : set prefix path (default: /usr/local/Cellar/nginx/1.17.3_1/) -c filename : set configuration file (default: /usr/local/etc/nginx/nginx."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="nginx"><meta name=twitter:description content="命令    Options: -?,-h : this help -v : show version and exit -V : show version and configure options then exit -t : test configuration and exit -T : test configuration, dump it and exit -q : suppress non-error messages during configuration testing -s signal : send signal to a master process: stop, quit, reopen, reload -p prefix : set prefix path (default: /usr/local/Cellar/nginx/1.17.3_1/) -c filename : set configuration file (default: /usr/local/etc/nginx/nginx."><meta property="og:title" content="nginx"><meta property="og:description" content="命令    Options: -?,-h : this help -v : show version and exit -V : show version and configure options then exit -t : test configuration and exit -T : test configuration, dump it and exit -q : suppress non-error messages during configuration testing -s signal : send signal to a master process: stop, quit, reopen, reload -p prefix : set prefix path (default: /usr/local/Cellar/nginx/1.17.3_1/) -c filename : set configuration file (default: /usr/local/etc/nginx/nginx."><meta property="og:type" content="article"><meta property="og:url" content="https://chenkai.life/tools/nginx/"><meta property="article:published_time" content="2021-07-09T15:37:56+08:00"><meta property="article:modified_time" content="2021-07-09T15:37:56+08:00"><title>nginx · CK's Blog</title><link rel=canonical href=https://chenkai.life/tools/nginx/><link rel=stylesheet href=/css/coder.min.0e0f0ac9929898ae6625ca3789e3f9e2e630ead0a5e0f1fe96c1ba7d8774342c.css integrity="sha256-Dg8KyZKYmK5mJco3ieP54uYw6tCl4PH+lsG6fYd0NCw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.d8f89ef09509afb63b9b2595ee174e53cc51ce02a6f6a2179e1621f9389e4340.css integrity="sha256-2Pie8JUJr7Y7myWV7hdOU8xRzgKm9qIXnhYh+TieQ0A=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/custom.min.ffed55576b1fe8cd1a532c3c9691900c09813ce5a8e0fbf58a6e377169305cf3.css integrity="sha256-/+1VV2sf6M0aUyw8lpGQDAmBPOWo4Pv1im43cWkwXPM=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.72.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><span id=dark-mode-toggle class=colorscheme-toggle><svg class="icon" aria-hidden="true"><use xlink:href="#icon-anheimoshi"/></svg></span></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>CK's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><svg class="icon" aria-hidden="true"><use xlink:href="#icon-caidan"/></svg></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/>Home</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/index.xml>RSS</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item id=search-content><input class=search-int type=text placeholder=Search>
<button class=search-btn data-type=google>Google</button>
<button class=search-btn data-type=github>GitHub</button></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://chenkai.life/tools/nginx/>nginx</a></h1><div class=edit-link style=float:right;color:#0366d6><a class=title target=_blank href=https://github.com/chenkai0520/chenkai0520.github.io/edit/main/content/tools/nginx.md>编辑</a></div></header><div class=post-meta><div class=date><span class=posted-on><svg class="icon" aria-hidden="true"><use xlink:href="#icon-date"/></svg><time datetime=2021-07-09T15:37:56+08:00>2021-07-09</time></span></div><div class=tags><svg class="icon" aria-hidden="true"><use xlink:href="#icon-biaoqian"/></svg><span class=tag><a href=/tags/tool/>tool</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/nginx/>nginx</a></span></div></div><h2 id=命令>命令
<a class=heading-link href=#%e5%91%bd%e4%bb%a4><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Options:
  -?,-h         : this help
  -v            : show version and exit
  -V            : show version and configure options <span style=color:#66d9ef>then</span> exit
  -t            : test configuration and exit
  -T            : test configuration, dump it and exit
  -q            : suppress non-error messages during configuration testing
  -s signal     : send signal to a master process: stop, quit, reopen, reload
  -p prefix     : set prefix path <span style=color:#f92672>(</span>default: /usr/local/Cellar/nginx/1.17.3_1/<span style=color:#f92672>)</span>
  -c filename   : set configuration file <span style=color:#f92672>(</span>default: /usr/local/etc/nginx/nginx.conf<span style=color:#f92672>)</span>
  -g directives : set global directives out of configuration file

<span style=color:#75715e>## 启动</span> 
nginx

<span style=color:#75715e>## 重启</span>
nginx -s reload


<span style=color:#75715e>## 要获取所有 running nginx 进程的列表，可以使用ps实用程序，例如</span>
ps -ax | grep nginx
</code></pre></div><h2 id=nginxconfig>nginx.config
<a class=heading-link href=#nginxconfig><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>
<span style=color:#75715e>#user  nobody;</span>
worker_processes  1;

<span style=color:#75715e>#error_log  logs/error.log;</span>
<span style=color:#75715e>#error_log  logs/error.log  notice;</span>
<span style=color:#75715e>#error_log  logs/error.log  info;</span>

<span style=color:#75715e>#pid        logs/nginx.pid;</span>


events <span style=color:#f92672>{</span>
    worker_connections  1024;
<span style=color:#f92672>}</span>


http <span style=color:#f92672>{</span>
    include       mime.types;
    default_type  application/octet-stream;

    <span style=color:#75715e>#log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
    <span style=color:#75715e>#                  &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
    <span style=color:#75715e>#                  &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;</span>

    <span style=color:#75715e>#access_log  logs/access.log  main;</span>

    sendfile        on;
    <span style=color:#75715e>#tcp_nopush     on;</span>

    <span style=color:#75715e>#keepalive_timeout  0;</span>
    keepalive_timeout  65;

    <span style=color:#75715e>#gzip  on;</span>

    gzip on;
    gzip_static on;
    gzip_min_length 1024;
    gzip_buffers <span style=color:#ae81ff>4</span> 16k;
    gzip_comp_level 2;
    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;
    gzip_vary off;
    gzip_disable <span style=color:#e6db74>&#34;MSIE [1-6]\.&#34;</span>;

    
    <span style=color:#75715e># 重定向</span>
    rewrite  <span style=color:#f92672>(</span>.*<span style=color:#f92672>)</span>  http://geohey.com$1;


    server <span style=color:#f92672>{</span>
        listen       80;


        location / <span style=color:#f92672>{</span>  
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods <span style=color:#e6db74>&#39;GET, POST, OPTIONS&#39;</span>;
            add_header Access-Control-Allow-Headers <span style=color:#e6db74>&#39;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#39;</span>;

            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>$request_method <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;OPTIONS&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>return</span> 204;
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> 
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><h2 id=常见问题>常见问题
<a class=heading-link href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li>nginx访问时报403
<code>ps aux | grep nginx</code></li></ul><pre><code>root             66372   0.0  0.0  4300068   1584   ??  Ss   五06下午   0:00.10 nginx: master process nginx
nobody           20442   0.0  0.0  4300320   1272   ??  S     2:02下午   0:00.00 nginx: worker process
nobody           20441   0.0  0.0  4300320   1584   ??  S     2:02下午   0:00.00 nginx: worker process
nobody           20440   0.0  0.0  4300320   1332   ??  S     2:02下午   0:00.00 nginx: worker process
nobody           20439   0.0  0.0  4300320   1256   ??  S     2:02下午   0:00.00 nginx: worker process
</code></pre><p>由于启动用户和nginx工作用户不一致所致,将nginx.config的user改为和启动用户一致,修改nginx.config</p><pre><code>user root everyone;
</code></pre><ul><li>某些文件加载失败控制台<code>net::err_content_length_mismatch</code>，
查看日志文件发现类似下面错误</li></ul><pre><code>open() &quot;/usr/local/var/run/nginx/proxy_temp/1/04/0000000041&quot; failed (13: Permission denied) while reading upstream, client: 127.0.0.1,
</code></pre><p>查看当前nginx用户</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell> ps aux | grep <span style=color:#e6db74>&#34;nginx: worker process&#34;</span>
</code></pre></div><p>修改目录权限</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo chown -R youn_name /usr/local/var/run/nginx/proxy_temp
</code></pre></div><div id=vcomments></div></article></section></div></main><script src=/js/coder.min.a350362441276ec5c1671926420497bb8e52b63ead1d51d3c9bc4342d0039526.js integrity="sha256-o1A2JEEnbsXBZxkmQgSXu45Stj6tHVHTybxDQtADlSY="></script><script src=/js/custom.js></script><script src=/js/font.min.js></script></body></html>