<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=theme-color content="#ffffff"><meta name=color-scheme content="light dark"><meta name=description content="使用koa创建服务 使用koa我们可以很容易创建一个http服务
const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); app.listen(3000); 其中app.listen(...) 方法只是以下内容的糖：
const http = require('http'); const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); http.createServer(app.callback()).listen(3000) 创建一个http2服务 想当然的我们可能会首先尝试使用一下代码创建一个http2服务
const http2 = require('http2'); const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); http2."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="使用koa创建基于http2的服务"><meta name=twitter:description content="使用koa创建服务 使用koa我们可以很容易创建一个http服务
const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); app.listen(3000); 其中app.listen(...) 方法只是以下内容的糖：
const http = require('http'); const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); http.createServer(app.callback()).listen(3000) 创建一个http2服务 想当然的我们可能会首先尝试使用一下代码创建一个http2服务
const http2 = require('http2'); const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); http2."><meta property="og:title" content="使用koa创建基于http2的服务"><meta property="og:description" content="使用koa创建服务 使用koa我们可以很容易创建一个http服务
const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); app.listen(3000); 其中app.listen(...) 方法只是以下内容的糖：
const http = require('http'); const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); http.createServer(app.callback()).listen(3000) 创建一个http2服务 想当然的我们可能会首先尝试使用一下代码创建一个http2服务
const http2 = require('http2'); const Koa = require('koa'); const app = new Koa(); app.use(async ctx => { ctx.body = 'Hello World'; }); http2."><meta property="og:type" content="article"><meta property="og:url" content="https://chenkai.life/nodejs/koa-http2/"><meta property="article:section" content="nodejs"><meta property="article:published_time" content="2021-07-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-13T08:38:51+08:00"><title>使用koa创建基于http2的服务 · CK's Blog</title><link rel=canonical href=https://chenkai.life/nodejs/koa-http2/><link rel=stylesheet href=/css/coder.min.0e0f0ac9929898ae6625ca3789e3f9e2e630ead0a5e0f1fe96c1ba7d8774342c.css integrity="sha256-Dg8KyZKYmK5mJco3ieP54uYw6tCl4PH+lsG6fYd0NCw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.d8f89ef09509afb63b9b2595ee174e53cc51ce02a6f6a2179e1621f9389e4340.css integrity="sha256-2Pie8JUJr7Y7myWV7hdOU8xRzgKm9qIXnhYh+TieQ0A=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/custom.min.d12542c00c198b6a07ca9ea5981102805aecab0f5dfd5e3273d8c179088712c4.css integrity="sha256-0SVCwAwZi2oHyp6lmBECgFrsqw9d/V4yc9jBeQiHEsQ=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/favicon.ico><link rel=apple-touch-icon type=image/png sizes=256x256 href=/images/favicon-512x512.png><meta name=generator content="Hugo 0.119.0"><link rel=manifest href=/manifest.webmanifest></head><body class="preload-transitions colorscheme-auto"><div class=float-container><span id=dark-mode-toggle class=colorscheme-toggle><svg class="icon" aria-hidden="true"><use xlink:href="#icon-anheimoshi"/></svg></span></div><details id=table-of-contents-wapper><summary><svg class="icon" aria-hidden="true"><use xlink:href="#icon-caidan"/></svg></summary></details><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>CK's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><svg class="icon" aria-hidden="true"><use xlink:href="#icon-caidan"/></svg></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/>Home</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/marks/>Marks</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/ckvv/ckvv.github.io/tree/main/content>Create</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item id=search-content><input class=search-int type=text placeholder=Search>
<button class=search-btn data-type=github>GitHub</button>
<button class=search-btn data-type=google>Google</button></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://chenkai.life/nodejs/koa-http2/>使用koa创建基于http2的服务</a></h1><div class=edit-link style=float:right;color:#0366d6><a class=title rel=noopener target=_blank href=https://github.com/ckvv/ckvv.github.io/edit/main/content/nodejs/koa-http2.md>编辑</a></div></header><div class=post-meta><div class=date><span class=posted-on><svg class="icon" aria-hidden="true"><use xlink:href="#icon-date"/></svg><time datetime=2021-07-09T00:00:00Z>2021-07-09</time></span></div></div><h1 id=使用koa创建服务>使用koa创建服务
<a class=heading-link href=#%e4%bd%bf%e7%94%a8koa%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1><i class="fa fa-link" aria-hidden=true></i></a></h1><p>使用koa我们可以很容易创建一个http服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Koa</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;koa&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Koa</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>ctx</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello World&#39;</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>);
</span></span></code></pre></div><p>其中<code>app.listen(...)</code> 方法只是以下内容的糖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Koa</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;koa&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Koa</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>ctx</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello World&#39;</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>callback</span>()).<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>)
</span></span></code></pre></div><h1 id=创建一个http2服务>创建一个http2服务
<a class=heading-link href=#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aahttp2%e6%9c%8d%e5%8a%a1><i class="fa fa-link" aria-hidden=true></i></a></h1><p>想当然的我们可能会首先尝试使用一下代码创建一个http2服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http2&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Koa</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;koa&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Koa</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>ctx</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello World&#39;</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>http2</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>callback</span>()).<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>)
</span></span></code></pre></div><p>但是这样的代码会并不支持浏览器访问，没有已知的浏览器支持未加密的 HTTP/2，因此在与浏览器客户端通信时必须使用 <code>http2.createSecureServer()</code> ,但是createSecureServer需要证书和密钥，</p><p>为了此示例生成证书和密钥，我们可以运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -newkey rsa:2048 -nodes -sha256 -subj <span style=color:#e6db74>&#39;/CN=localhost&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -keyout localhost-privkey.pem -out localhost-cert.pem
</span></span></code></pre></div><p>我们的代码就变成了这样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http2&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Koa</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;koa&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Koa</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>ctx</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello World&#39;</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>http2</span>.<span style=color:#a6e22e>createSecureServer</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>__dirname</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/localhost-privkey.pem`</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cert</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>__dirname</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/localhost-cert.pem`</span>),
</span></span><span style=display:flex><span>}, <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>callback</span>()).<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>);
</span></span></code></pre></div><p>接着我们打开浏览器尝试访问：<code>http://localhost:3000/</code>, 但是我们的服务器返回了一个错误，<code>server ERR_EMPTY_RESPONSE</code>这是因为我们需要使用<code>https://localhost:3000/</code>访问http2服务，这时打开谷歌调试窗口我们可以看到请求的<code>Protocol</code>为<code>h2</code>,我们也可以使用以下命令验证</p><pre tabindex=0><code>curl -vso /dev/null --http2 https://localhost:3000/
</code></pre><p>我们可以看到类似信息</p><pre tabindex=0><code>* ALPN, offering h2
* ALPN, offering http/1.1
</code></pre><h1 id=让-chrome-接受自签名的-localhost-证书>让 Chrome 接受自签名的 localhost 证书
<a class=heading-link href=#%e8%ae%a9-chrome-%e6%8e%a5%e5%8f%97%e8%87%aa%e7%ad%be%e5%90%8d%e7%9a%84-localhost-%e8%af%81%e4%b9%a6><i class="fa fa-link" aria-hidden=true></i></a></h1><p>对于自签名的证书Chrome会仍然坚持认证证书不可信，可以通过下面的方式让chrome接受自签名的证书（仅限localhost的证书）</p><pre tabindex=0><code>chrome://flags/#allow-insecure-localhost
</code></pre><div id=cusdis_thread data-host=https://cusdis.com data-app-id=c2b015f9-9a4b-4997-b66f-f9c6ca26ebdd data-page-id=cd6751ec3bfb5ec07d5a9baac128beb2 data-page-url=https://chenkai.life/nodejs/koa-http2/ data-page-title=使用koa创建基于http2的服务 data-iframe=/js/cusdis/iframe.umd.js data-style=/js/cusdis/style.css></div></article></section></div></main><script src=/js/coder.min.cb0c595e02234420f3ad3886bf4a9bd2874d0e1e78e090138a9ef158b35aaf17.js integrity="sha256-ywxZXgIjRCDzrTiGv0qb0odNDh544JATip7xWLNarxc="></script>
<script src=/js/custom.js></script>
<script src=/js/font.min.js></script></body><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js")</script></html>