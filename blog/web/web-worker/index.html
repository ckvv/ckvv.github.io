<!DOCTYPE html><html lang="zh-CN" class="h-full bg-white"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.ico"><meta name="generator" content="Astro v5.7.12"><!-- Canonical URL --><link rel="canonical" href="https://ckvv.net/blog/web/web-worker/"><!-- Primary Meta Tags --><title>WebWorker</title><meta name="title" content="WebWorker"><meta name="description" content="I am a Web full-stack engineer. I like Vue.js and Node.js. This is my blog, where I mainly share my thoughts, experiences, or knowledge."><link rel="stylesheet" href="/_astro/about.B0Cw6WDJ.css">
<style>.outline-item-active[data-astro-cid-v2nb7cev]{color:var(--color-sky-700)}
</style></head> <body class="flex flex-col min-h-full"> <header class="sticky top-0 px-4 bg-white z-50 shadow-md"> <nav class="w-full max-w-6xl m-auto elect-none flex justify-between items-center text-2xl my-3 md:my-4"> <div class="flex gap-2 md:gap-4 items-center font-bold"> <h2><a href="/">CK Blog</a></h2> </div> <span data-astro-button-menu class="md:hidden select-none cursor-pointer text-3xl leading-none">☰</span> <div class="z-20 md:visible! flex gap-2 md:gap-4 flex-col md:flex-row max-md:absolute max-md:bg-white max-md:left-0 max-md:right-0 max-md:top-14 max-md:gap-4 max-md:py-6 max-md:shadow max-md:border-t max-md:border-gray-300 max-md:invisible"> <a href="/" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1 justify-center"> Home <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-[width] duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a><a href="/tag/" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1 justify-center"> Tag <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-[width] duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a><a href="/assets/" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1 justify-center"> Assets <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-[width] duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a><a href="/about/" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1 justify-center"> About <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-[width] duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a> <a href="https://github.com/ckvv/ckvv.github.io" target="_blank" aria-label="GitHub"> <svg width="32" height="32" viewBox="0 0 32 32" fill="none" class="m-auto">
<path fill-rule="evenodd" clip-rule="evenodd" d="M16 0C7.16 0 0 7.16 0 16C0 23.08 4.58 29.06 10.94 31.18C11.74 31.32 12.04 30.84 12.04 30.42C12.04 30.04 12.02 28.78 12.02 27.44C8 28.18 6.96 26.46 6.64 25.56C6.46 25.1 5.68 23.68 5 23.3C4.44 23 3.64 22.26 4.98 22.24C6.24 22.22 7.14 23.4 7.44 23.88C8.88 26.3 11.18 25.62 12.1 25.2C12.24 24.16 12.66 23.46 13.12 23.06C9.56 22.66 5.84 21.28 5.84 15.16C5.84 13.42 6.46 11.98 7.48 10.86C7.32 10.46 6.76 8.82 7.64 6.62C7.64 6.62 8.98 6.2 12.04 8.26C13.32 7.9 14.68 7.72 16.04 7.72C17.4 7.72 18.76 7.9 20.04 8.26C23.1 6.18 24.44 6.62 24.44 6.62C25.32 8.82 24.76 10.46 24.6 10.86C25.62 11.98 26.24 13.4 26.24 15.16C26.24 21.3 22.5 22.66 18.94 23.06C19.52 23.56 20.02 24.52 20.02 26.02C20.02 28.16 20 29.88 20 30.42C20 30.84 20.3 31.34 21.1 31.18C27.42 29.06 32 23.06 32 16C32 7.16 24.84 0 16 0V0Z" fill="#24292E" />
</svg> </a> </div> </nav> </header> <script type="module">document.querySelector("[data-astro-button-menu]")?.addEventListener("click",e=>{const t=e.target?.nextElementSibling;t&&(getComputedStyle(t).visibility==="hidden"?(e.target.textContent="✕",t.style.visibility="visible"):(e.target.textContent="☰",t.style.visibility="hidden"))});</script> <main class="w-full max-w-5xl mx-auto px-4 py-8 flex-grow font-tabular-nums">  <h1 class="text-4xl font-bold my-4">WebWorker</h1>
  <div class="my-2 flex justify-between items-center"><div class="flex gap-4"><a href="/tag/web/" class="bg-gray-100 hover:bg-gray-300 text-sky-700 px-2 py-1 rounded cursor-pointer"> web </a><a href="/tag/webworker/" class="bg-gray-100 hover:bg-gray-300 text-sky-700 px-2 py-1 rounded cursor-pointer"> webworker </a></div><span class="tabular-nums"> 2021/12/29 </span></div>
  <div class="sticky z-10 top-20 inline-block text-left w-full" data-astro-cid-v2nb7cev><div class="2xl:hidden flex justify-end" data-astro-cid-v2nb7cev><button type="button" class="shadow-md inline-flex justify-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-50" id="menu-button" aria-expanded="false" aria-haspopup="true" data-astro-cid-v2nb7cev>
On this page
<svg class="-mr-1 size-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon" data-astro-cid-v2nb7cev><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" data-astro-cid-v2nb7cev></path></svg></button></div><div id="md-outline-content" class="max-h-[calc(100vh-200px)] overflow-auto hidden absolute right-0 py-2 mt-2 min-w-48 max-w-full origin-top-right rounded-md bg-white ring-1 shadow-lg ring-black/5 focus:outline-hidden 2xl:-right-12 2xl:float-right 2xl:translate-x-full 2xl:max-w-[min(calc(50vw-580px),320px)]" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1" data-astro-cid-v2nb7cev><a class="outline-item block px-4 py-1 text-sm break-all" href="#一概述" data-astro-cid-v2nb7cev>一、概述</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#二基本用法" data-astro-cid-v2nb7cev>二、基本用法</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#21-主线程" data-astro-cid-v2nb7cev>2.1 主线程</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#22-worker-线程" data-astro-cid-v2nb7cev>2.2 Worker 线程</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#23-worker-加载脚本" data-astro-cid-v2nb7cev>2.3 Worker 加载脚本</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#24-错误处理" data-astro-cid-v2nb7cev>2.4 错误处理</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#25-关闭-worker" data-astro-cid-v2nb7cev>2.5 关闭 Worker</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#三数据通信" data-astro-cid-v2nb7cev>三、数据通信</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#四同页面的-web-worker" data-astro-cid-v2nb7cev>四、同页面的 Web Worker</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#五实例worker-线程完成轮询" data-astro-cid-v2nb7cev>五、实例：Worker 线程完成轮询</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#六实例-worker-新建-worker" data-astro-cid-v2nb7cev>六、实例： Worker 新建 Worker</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#七api" data-astro-cid-v2nb7cev>七、API</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#71-主线程" data-astro-cid-v2nb7cev>7.1 主线程</a><a class="outline-item block px-4 py-1 text-sm break-all" href="#72-worker-线程" data-astro-cid-v2nb7cev>7.2 Worker 线程</a></div></div><script type="module">function f(n,o){let r,t;return(...c)=>{t?(clearTimeout(r),r=setTimeout(()=>{Date.now()-t>=o&&(n(...c),t=Date.now())},o-(Date.now()-t))):(n(...c),t=Date.now())}}function u(n){const o=document.getElementById("menu-button"),r=document.getElementById("md-outline-content"),t=n===void 0?o.getAttribute("aria-expanded")==="true":!n;o.setAttribute("aria-expanded",`${!t}`),r.style.display=t?"none":"block"}function l(){window.innerWidth>=1536&&u(!0)}window.addEventListener("resize",l);document.addEventListener("DOMContentLoaded",()=>{l();const n=document.getElementById("md-outline-content");n.onclick=e=>{e.preventDefault();const i=document.querySelector(e.target.getAttribute("href"));i&&window.scrollTo({top:i.offsetTop-64,behavior:"smooth"})};const o=document.getElementById("menu-button");o.onclick=()=>u(),document.onclick=e=>{if(window.innerWidth>=1536)return;const i=document.getElementById("md-outline-content");e.target.id!=="menu-button"&&!i.contains(e.target)&&o.getAttribute("aria-expanded")==="true"&&u()};const r=document.querySelector(".content").querySelectorAll("h1, h2, h3"),t=document.querySelectorAll(".outline-item"),c={root:null,rootMargin:"0px",threshold:.6},a=f(e=>{e.forEach(i=>{if(i.isIntersecting){const b=i.target.getAttribute("id");t.forEach(s=>{const d=`#${b}`;s.classList.remove("outline-item-active"),s.getAttribute("href")===d&&(s.classList.add("outline-item-active"),history.replaceState(null,"",d))})}})},200),m=new IntersectionObserver(a,c);r.forEach(e=>{m.observe(e)})});</script><div class="content"> <h2 id="一概述">一、概述</h2>
<p>JavaScript 语言采用的是单线程模型，也就是说，所有任务只能在一个线程上完成，一次只能做一件事。前面的任务没做完，后面的任务只能等着。随着电脑计算能力的增强，尤其是多核 CPU 的出现，单线程带来很大的不便，无法充分发挥计算机的计算能力。</p>
<p>Web Worker 的作用，就是为 JavaScript 创造多线程环境，允许主线程创建 Worker 线程，将一些任务分配给后者运行。在主线程运行的同时，Worker 线程在后台运行，两者互不干扰。等到 Worker 线程完成计算任务，再把结果返回给主线程。这样的好处是，一些计算密集型或高延迟的任务，被 Worker 线程负担了，主线程（通常负责 UI 交互）就会很流畅，不会被阻塞或拖慢。</p>
<p>Worker 线程一旦新建成功，就会始终运行，不会被主线程上的活动（比如用户点击按钮、提交表单）打断。这样有利于随时响应主线程的通信。但是，这也造成了 Worker 比较耗费资源，不应该过度使用，而且一旦使用完毕，就应该关闭。</p>
<p>Web Worker 有以下几个使用注意点。</p>
<p>（1）<strong>同源限制</strong></p>
<p>分配给 Worker 线程运行的脚本文件，必须与主线程的脚本文件同源。</p>
<p>（2）<strong>DOM 限制</strong></p>
<p>Worker 线程所在的全局对象，与主线程不一样，无法读取主线程所在网页的 DOM 对象，也无法使用<code>document</code>、<code>window</code>、<code>parent</code>这些对象。但是，Worker 线程可以<code>navigator</code>对象和<code>location</code>对象。</p>
<p>（3）<strong>通信联系</strong></p>
<p>Worker 线程和主线程不在同一个上下文环境，它们不能直接通信，必须通过消息完成。</p>
<p>（4）<strong>脚本限制</strong></p>
<p>Worker 线程不能执行<code>alert()</code>方法和<code>confirm()</code>方法，但可以使用 XMLHttpRequest 对象发出 AJAX 请求。</p>
<p>（5）<strong>文件限制</strong></p>
<p>Worker 线程无法读取本地文件，即不能打开本机的文件系统（<code>file://</code>），它所加载的脚本，必须来自网络。</p>
<h2 id="二基本用法">二、基本用法</h2>
<h3 id="21-主线程">2.1 主线程</h3>
<p>主线程采用<code>new</code>命令，调用<code>Worker()</code>构造函数，新建一个 Worker 线程。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'work.js'</span><span style="color:#E1E4E8">);</span></span></code></pre>
<p><code>Worker()</code>构造函数的参数是一个脚本文件，该文件就是 Worker 线程所要执行的任务。由于 Worker 不能读取本地文件，所以这个脚本必须来自网络。如果下载没有成功（比如 404 错误），Worker 就会默默地失败。</p>
<p>然后，主线程调用<code>worker.postMessage()</code>方法，向 Worker 发消息。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Hello World'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">({ method: </span><span style="color:#9ECBFF">'echo'</span><span style="color:#E1E4E8">, args: [</span><span style="color:#9ECBFF">'Work'</span><span style="color:#E1E4E8">] });</span></span></code></pre>
<p><code>worker.postMessage()</code>方法的参数，就是主线程传给 Worker 的数据。它可以是各种数据类型，包括二进制数据。</p>
<p>接着，主线程通过<code>worker.onmessage</code>指定监听函数，接收子线程发回来的消息。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">  console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Received message ${</span><span style="color:#E1E4E8">event</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">  doSomething</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> doSomething</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // 执行任务</span></span>
<span class="line"><span style="color:#E1E4E8">  worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Work done!'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>上面代码中，事件对象的<code>data</code>属性可以获取 Worker 发来的数据。</p>
<p>Worker 完成任务以后，主线程就可以把它关掉。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">terminate</span><span style="color:#E1E4E8">();</span></span></code></pre>
<h3 id="22-worker-线程">2.2 Worker 线程</h3>
<p>Worker 线程内部需要有一个监听函数，监听<code>message</code>事件。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">self.</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">  'message'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    self.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`You said: ${</span><span style="color:#E1E4E8">e</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#79B8FF">  false</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre>
<p>上面代码中，<code>self</code>代表子线程自身，即子线程的全局对象。因此，等同于下面两种写法。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// 写法一</span></span>
<span class="line"><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">  'message'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">  function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`You said: ${</span><span style="color:#E1E4E8">e</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#79B8FF">  false</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// 写法二</span></span>
<span class="line"><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">  'message'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`You said: ${</span><span style="color:#E1E4E8">e</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#79B8FF">  false</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre>
<p>除了使用<code>self.addEventListener()</code>指定监听函数，也可以使用<code>self.onmessage</code>指定。监听函数的参数是一个事件对象，它的<code>data</code>属性包含主线程发来的数据。<code>self.postMessage()</code>方法用来向主线程发送消息。</p>
<p>根据主线程发来的数据，Worker 线程可以调用不同的方法，下面是一个例子。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">self.</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">  'message'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> data</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> e.data;</span></span>
<span class="line"><span style="color:#F97583">    switch</span><span style="color:#E1E4E8"> (data.cmd) {</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'start'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        self.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`WORKER STARTED: ${</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">msg</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'stop'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        self.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`WORKER STOPPED: ${</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">msg</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        self.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">(); </span><span style="color:#6A737D">// Terminates the worker.</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        self.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Unknown command: ${</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">msg</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#79B8FF">  false</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre>
<p>上面代码中，<code>self.close()</code>用于在 Worker 内部关闭自身。</p>
<h3 id="23-worker-加载脚本">2.3 Worker 加载脚本</h3>
<p>Worker 内部如果要加载其他脚本，有一个专门的方法<code>importScripts()</code>。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#B392F0">importScripts</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'script1.js'</span><span style="color:#E1E4E8">);</span></span></code></pre>
<p>该方法可以同时加载多个脚本。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#B392F0">importScripts</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'script1.js'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'script2.js'</span><span style="color:#E1E4E8">);</span></span></code></pre>
<h3 id="24-错误处理">2.4 错误处理</h3>
<p>主线程可以监听 Worker 是否发生错误。如果发生错误，Worker 会触发主线程的<code>error</code>事件。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onerror</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#9ECBFF">'ERROR: Line '</span><span style="color:#E1E4E8">, e.lineno, </span><span style="color:#9ECBFF">' in '</span><span style="color:#E1E4E8">, e.filename, </span><span style="color:#9ECBFF">': '</span><span style="color:#E1E4E8">, e.message].</span><span style="color:#B392F0">join</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">''</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// 或者</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">addEventListener</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'error'</span><span style="color:#E1E4E8">, (</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ...</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>Worker 内部也可以监听<code>error</code>事件。</p>
<h3 id="25-关闭-worker">2.5 关闭 Worker</h3>
<p>使用完毕，为了节省系统资源，必须关闭 Worker。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// 主线程</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">terminate</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Worker 线程</span></span>
<span class="line"><span style="color:#E1E4E8">self.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">();</span></span></code></pre>
<h2 id="三数据通信">三、数据通信</h2>
<p>前面说过，主线程与 Worker 之间的通信内容，可以是文本，也可以是对象。需要注意的是，这种通信是拷贝关系，即是传值而不是传址，Worker 对通信内容的修改，不会影响到主线程。事实上，浏览器内部的运行机制是，先将通信内容串行化，然后把串行化后的字符串发给 Worker，后者再将它还原。</p>
<p>主线程与 Worker 之间也可以交换二进制数据，比如 File、Blob、ArrayBuffer 等类型，也可以在线程之间发送。下面是一个例子。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// 主线程</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> uInt8Array</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Uint8Array</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> uInt8Array.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">i) {</span></span>
<span class="line"><span style="color:#E1E4E8">  uInt8Array[i] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// [0, 2, 4, 6, 8,...]</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(uInt8Array);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Worker 线程</span></span>
<span class="line"><span style="color:#E1E4E8">self.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> uInt8Array</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> e.data;</span></span>
<span class="line"><span style="color:#B392F0">  postMessage</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">    `Inside worker.js: uInt8Array.toString() = ${</span><span style="color:#E1E4E8">uInt8Array</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">toString</span><span style="color:#9ECBFF">()</span><span style="color:#9ECBFF">}`</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#B392F0">  postMessage</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">    `Inside worker.js: uInt8Array.byteLength = ${</span><span style="color:#E1E4E8">uInt8Array</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">byteLength</span><span style="color:#9ECBFF">}`</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>但是，拷贝方式发送二进制数据，会造成性能问题。比如，主线程向 Worker 发送一个 500MB 文件，默认情况下浏览器会生成一个原文件的拷贝。为了解决这个问题，JavaScript 允许主线程把二进制数据直接转移给子线程，但是一旦转移，主线程就无法再使用这些二进制数据了，这是为了防止出现多个线程同时修改数据的麻烦局面。这种转移数据的方法，叫做<a href="http://www.w3.org/html/wg/drafts/html/master/infrastructure.html#transferable-objects">Transferable Objects</a>。这使得主线程可以快速把数据交给 Worker，对于影像处理、声音处理、3D 运算等就非常方便了，不会产生性能负担。</p>
<p>如果要直接转移数据的控制权，就要使用下面的写法。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// Transferable Objects 格式</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(arrayBuffer, [arrayBuffer]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// 例子</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> ab</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(ab, [ab]);</span></span></code></pre>
<h2 id="四同页面的-web-worker">四、同页面的 Web Worker</h2>
<p>通常情况下，Worker 载入的是一个单独的 JavaScript 脚本文件，但是也可以载入与主线程在同一个网页的代码。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#E1E4E8">&#x3C;!</span><span style="color:#85E89D">DOCTYPE</span><span style="color:#B392F0"> html</span></span>
<span class="line"><span style="color:#B392F0">  &#x3C;body</span></span>
<span class="line"><span style="color:#B392F0">    &#x3C;script</span><span style="color:#B392F0"> id="worker"</span><span style="color:#B392F0"> type="app/worker"</span></span>
<span class="line"><span style="color:#B392F0">      addEventListener('message',</span><span style="color:#B392F0"> function</span><span style="color:#B392F0"> ()</span><span style="color:#B392F0"> {</span></span>
<span class="line"><span style="color:#B392F0">        postMessage('some</span><span style="color:#B392F0"> message');</span></span>
<span class="line"><span style="color:#B392F0">      },</span><span style="color:#B392F0"> false);</span></span>
<span class="line"><span style="color:#B392F0">    &#x3C;/script</span></span>
<span class="line"><span style="color:#B392F0">  &#x3C;/body</span></span>
<span class="line"><span style="color:#B392F0">&#x3C;/html</span></span></code></pre>
<p>上面是一段嵌入网页的脚本，注意必须指定“标签的<code>type</code>属性是一个浏览器不认识的值，上例是<code>app/worker</code>。</p>
<p>然后，读取这一段嵌入页面的脚本，用 Worker 来处理。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> blob</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Blob</span><span style="color:#E1E4E8">([document.</span><span style="color:#B392F0">querySelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'#worker'</span><span style="color:#E1E4E8">).textContent]);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> url</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> window.</span><span style="color:#79B8FF">URL</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createObjectURL</span><span style="color:#E1E4E8">(blob);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">  // e.data === 'some message'</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>上面代码中，先将嵌入网页的脚本代码，转成一个二进制对象，然后为这个二进制对象生成 URL，再让 Worker 加载这个 URL。这样就做到了，主线程和 Worker 的代码都在同一个网页上面。或者</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">// URL.createObjectURL</span></span>
<span class="line"><span style="color:#E1E4E8">window.</span><span style="color:#79B8FF">URL</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> window.</span><span style="color:#79B8FF">URL</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> window.webkitURL;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// "Server response", used in all examples</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> response</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'self.onmessage=function(e){postMessage(</span><span style="color:#79B8FF">\'</span><span style="color:#9ECBFF">Worker: </span><span style="color:#79B8FF">\'</span><span style="color:#9ECBFF">+e.data);}'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> blob;</span></span>
<span class="line"><span style="color:#F97583">try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  blob </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Blob</span><span style="color:#E1E4E8">([response], { type: </span><span style="color:#9ECBFF">'application/javascript'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">} </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e) {</span></span>
<span class="line"><span style="color:#6A737D">  // Backwards-compatibility</span></span>
<span class="line"><span style="color:#E1E4E8">  window.BlobBuilder</span></span>
<span class="line"><span style="color:#F97583">    =</span><span style="color:#E1E4E8"> window.BlobBuilder </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> window.WebKitBlobBuilder </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> window.MozBlobBuilder;</span></span>
<span class="line"><span style="color:#E1E4E8">  blob </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> BlobBuilder</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  blob.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(response);</span></span>
<span class="line"><span style="color:#E1E4E8">  blob </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> blob.</span><span style="color:#B392F0">getBlob</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">URL</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createObjectURL</span><span style="color:#E1E4E8">(blob));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Test, used in all examples:</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">  alert</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Response: ${</span><span style="color:#E1E4E8">e</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">data</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Test'</span><span style="color:#E1E4E8">);</span></span></code></pre>
<h2 id="五实例worker-线程完成轮询">五、实例：Worker 线程完成轮询</h2>
<p>有时，浏览器需要轮询服务器状态，以便第一时间得知状态改变。这个工作可以放在 Worker 里面。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> createWorker</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">f</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  var</span><span style="color:#E1E4E8"> blob </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Blob</span><span style="color:#E1E4E8">([</span><span style="color:#9ECBFF">'('</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> f.</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">+</span><span style="color:#9ECBFF">')()'</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"><span style="color:#F97583">  var</span><span style="color:#E1E4E8"> url </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> window.</span><span style="color:#79B8FF">URL</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createObjectURL</span><span style="color:#E1E4E8">(blob);</span></span>
<span class="line"><span style="color:#F97583">  var</span><span style="color:#E1E4E8"> worker </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> worker;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> pollingWorker </span><span style="color:#F97583">=</span><span style="color:#B392F0"> createWorker</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  var</span><span style="color:#E1E4E8"> cache;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  function</span><span style="color:#B392F0"> compare</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">new</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">old</span><span style="color:#E1E4E8">) { </span><span style="color:#F97583">...</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  setInterval</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#B392F0">    fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/my-api-endpoint'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">res</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      var</span><span style="color:#E1E4E8"> data </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> res.</span><span style="color:#B392F0">json</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">compare</span><span style="color:#E1E4E8">(data, cache)) {</span></span>
<span class="line"><span style="color:#E1E4E8">        cache </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> data;</span></span>
<span class="line"><span style="color:#E1E4E8">        self.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(data);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">  }, </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">pollingWorker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#6A737D">  // render data</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">pollingWorker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'init'</span><span style="color:#E1E4E8">);</span></span></code></pre>
<p>上面代码中，Worker 每秒钟轮询一次数据，然后跟缓存做比较。如果不一致，就说明服务端有了新的变化，因此就要通知主线程。</p>
<h2 id="六实例-worker-新建-worker">六、实例： Worker 新建 Worker</h2>
<p>Worker 线程内部还能再新建 Worker 线程（目前只有 Firefox 浏览器支持）。下面的例子是将一个计算密集的任务，分配到 10 个 Worker。</p>
<p>主线程代码如下。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'worker.js'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">worker.</span><span style="color:#B392F0">onmessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">  document.</span><span style="color:#B392F0">getElementById</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'result'</span><span style="color:#E1E4E8">).textContent </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.data;</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>Worker 线程代码如下。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// worker.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// settings</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> num_workers</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> items_per_worker</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1000000</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// start the workers</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> result </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> pending_workers </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> num_workers;</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> num_workers; i </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> worker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'core.js'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> items_per_worker);</span></span>
<span class="line"><span style="color:#E1E4E8">  worker.</span><span style="color:#B392F0">postMessage</span><span style="color:#E1E4E8">((i </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> items_per_worker);</span></span>
<span class="line"><span style="color:#E1E4E8">  worker.onmessage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> storeResult;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// handle the results</span></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> storeResult</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">  result </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> event.data;</span></span>
<span class="line"><span style="color:#E1E4E8">  pending_workers </span><span style="color:#F97583">-=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (pending_workers </span><span style="color:#F97583">&#x3C;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">    postMessage</span><span style="color:#E1E4E8">(result);</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#6A737D">// finished!</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>上面代码中，Worker 线程内部新建了 10 个 Worker 线程，并且依次向这 10 个 Worker 发送消息，告知了计算的起点和终点。计算任务脚本的代码如下。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// core.js</span></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> start;</span></span>
<span class="line"><span style="color:#E1E4E8">onmessage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> getStart;</span></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> getStart</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">  start </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.data;</span></span>
<span class="line"><span style="color:#E1E4E8">  onmessage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> getEnd;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">let</span><span style="color:#E1E4E8"> end;</span></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> getEnd</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">  end </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.data;</span></span>
<span class="line"><span style="color:#E1E4E8">  onmessage </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">  work</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> work</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> result </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> start; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> end; i </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // perform some complex calculation here</span></span>
<span class="line"><span style="color:#E1E4E8">    result </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#B392F0">  postMessage</span><span style="color:#E1E4E8">(result);</span></span>
<span class="line"><span style="color:#B392F0">  close</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h2 id="七api">七、API</h2>
<h3 id="71-主线程">7.1 主线程</h3>
<p>浏览器原生提供<code>Worker()</code>构造函数，用来供主线程生成 Worker 线程。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> myWorker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(jsUrl, options);</span></span></code></pre>
<p><code>Worker()</code>构造函数，可以接受两个参数。第一个参数是脚本的网址（必须遵守同源政策），该参数是必需的，且只能加载 JS 脚本，否则会报错。第二个参数是配置对象，该对象可选。它的一个作用就是指定 Worker 的名称，用来区分多个 Worker 线程。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// 主线程</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> myWorker</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Worker</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'worker.js'</span><span style="color:#E1E4E8">, { name: </span><span style="color:#9ECBFF">'myWorker'</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Worker 线程</span></span>
<span class="line"><span style="color:#E1E4E8">self.name; </span><span style="color:#6A737D">// myWorker</span></span></code></pre>
<p><code>Worker()</code>构造函数返回一个 Worker 线程对象，用来供主线程操作 Worker。Worker 线程对象的属性和方法如下。</p>
<ul>
<li>Worker.onerror：指定 error 事件的监听函数。</li>
<li>Worker.onmessage：指定 message 事件的监听函数，发送过来的数据在<code>Event.data</code>属性中。</li>
<li>Worker.onmessageerror：指定 messageerror 事件的监听函数。发送的数据无法序列化成字符串时，会触发这个事件。</li>
<li>Worker.postMessage()：向 Worker 线程发送消息。</li>
<li>Worker.terminate()：立即终止 Worker 线程。</li>
</ul>
<h3 id="72-worker-线程">7.2 Worker 线程</h3>
<p>Web Worker 有自己的全局对象，不是主线程的<code>window</code>，而是一个专门为 Worker 定制的全局对象。因此定义在<code>window</code>上面的对象和方法不是全部都可以使用。</p>
<p>Worker 线程有一些自己的全局属性和方法。</p>
<ul>
<li>self.name： Worker 的名字。该属性只读，由构造函数指定。</li>
<li>self.onmessage：指定<code>message</code>事件的监听函数。</li>
<li>self.onmessageerror：指定 messageerror 事件的监听函数。发送的数据无法序列化成字符串时，会触发这个事件。</li>
<li>self.close()：关闭 Worker 线程。</li>
<li>self.postMessage()：向产生这个 Worker 线程发送消息。</li>
<li>self.importScripts()：加载 JS 脚本。</li>
</ul>
<p><a href="http://www.ruanyifeng.com/blog/2018/07/web-worker.html">http://www.ruanyifeng.com/blog/2018/07/web-worker.html</a></p> </div> <a class="flex gap-1 my-4 text-blue-600 cursor-pointer select-none" href="https://github.com/ckvv/ckvv.github.io/tree/main/content/web/web-worker.md"> <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" class="w-4">
  <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
  <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z" />
</svg>
Edit this page on GitHub
</a> <script src="https://giscus.app/client.js" data-repo="ckvv/ckvv.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzODQzNjA2OTQ=" data-category="Announcements" data-category-id="DIC_kwDOFujg9s4CpN2G" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
</script>  </main> </body></html>