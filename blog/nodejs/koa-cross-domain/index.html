<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.ico"><meta name="generator" content="Astro v5.1.1"><!-- Canonical URL --><link rel="canonical" href="https://ckvv.net/blog/nodejs/koa-cross-domain/"><!-- Primary Meta Tags --><title>koa跨域</title><meta name="title" content="koa跨域"><meta name="description" content="Welcome to my website!"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://ckvv.net/blog/nodejs/koa-cross-domain/"><meta property="og:title" content="koa跨域"><meta property="og:description" content="Welcome to my website!"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://ckvv.net/blog/nodejs/koa-cross-domain/"><meta property="twitter:title" content="koa跨域"><meta property="twitter:description" content="Welcome to my website!"><link rel="stylesheet" href="/_astro/about.BK4bHC-I.css">
<style>[data-astro-image]{width:100%;height:auto;-o-object-fit:var(--fit);object-fit:var(--fit);-o-object-position:var(--pos);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body class="flex flex-col"> <header class="sticky top-0 px-4 bg-white opacity-1 z-10 shadow-md"> <nav class="w-full max-w-6xl m-auto elect-none flex justify-between items-center text-2xl my-4"> <div class="flex gap-2 md:gap-4 items-center"> <h2><a href="/">CK&#39;s Blog</a></h2> </div> <div class="flex gap-2 md:gap-4"> <a href="/" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1"> Home <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-width duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a> <a href="/tag" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1"> Tag <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-width duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a> <a href="/assets" class="group clink cursor-pointer shrink-0 select-none relative flex items-center hidden md:inline"> Assets <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-width duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a> <a href="/about" class="group clink cursor-pointer shrink-0 select-none relative flex items-center px-1"> About <div class="h-1 bg-blue-500 w-0 group-hover:w-full transition-width duration-500 ease-in-out absolute -bottom-1 left-0" style=""></div> </a> <a href="https://github.com/ckvv/ckvv.github.io" target="_blank" aria-label="GitHub" class="hidden md:inline"> <svg viewBox="0 0 32 32" role="img" width="32" height="32" fill="none">
<path fill-rule="evenodd" clip-rule="evenodd" d="M16 0C7.16 0 0 7.16 0 16C0 23.08 4.58 29.06 10.94 31.18C11.74 31.32 12.04 30.84 12.04 30.42C12.04 30.04 12.02 28.78 12.02 27.44C8 28.18 6.96 26.46 6.64 25.56C6.46 25.1 5.68 23.68 5 23.3C4.44 23 3.64 22.26 4.98 22.24C6.24 22.22 7.14 23.4 7.44 23.88C8.88 26.3 11.18 25.62 12.1 25.2C12.24 24.16 12.66 23.46 13.12 23.06C9.56 22.66 5.84 21.28 5.84 15.16C5.84 13.42 6.46 11.98 7.48 10.86C7.32 10.46 6.76 8.82 7.64 6.62C7.64 6.62 8.98 6.2 12.04 8.26C13.32 7.9 14.68 7.72 16.04 7.72C17.4 7.72 18.76 7.9 20.04 8.26C23.1 6.18 24.44 6.62 24.44 6.62C25.32 8.82 24.76 10.46 24.6 10.86C25.62 11.98 26.24 13.4 26.24 15.16C26.24 21.3 22.5 22.66 18.94 23.06C19.52 23.56 20.02 24.52 20.02 26.02C20.02 28.16 20 29.88 20 30.42C20 30.84 20.3 31.34 21.1 31.18C27.42 29.06 32 23.06 32 16C32 7.16 24.84 0 16 0V0Z" fill="#24292E" />
</svg> </a> </div> </nav> </header> <main class="w-full max-w-5xl mx-auto px-4 py-8 flex-grow">  <h1 class="text-4xl font-bold my-4">koa跨域</h1> <div class="my-2 flex justify-between"> <div class="flex gap-4"> <a href="/tag/koa/" class="bg-gray-100 hover:bg-gray-300 text-sky-700 px-2 py-1 rounded cursor-pointer"> koa </a> </div> <span> 2021/07/06 </span> </div> <div class="content"> <h2 id="跨域">跨域</h2>
<h2 id="为什么会有跨域问题">为什么会有跨域问题？</h2>
<p>这是浏览器的同源策略所造成的，同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。</p>
<blockquote>
<p>一定要注意跨域是浏览器的限制，其实你用抓包工具抓取接口数据，是可以看到接口已经把数据返回回来了，只是浏览器的限制，你获取不到数据。用postman请求接口能够请求到数据。这些再次印证了跨域是浏览器的限制。</p>
</blockquote>
<h2 id="如何解决跨域">如何解决跨域?</h2>
<ul>
<li>jsonp: 带有src属性的标签都可以用来， 但是只能处理GET请求</li>
<li>document.domain + iframe跨域</li>
<li>location.hash + iframe</li>
<li>window.name + iframe</li>
<li>postMessage跨域</li>
<li>Nginx配置反向代理</li>
<li>CORS（跨域资源共享）：支持所有类型的HTTP请求 相信大家对于以上的解决方法都很熟悉，这里不再对每一种方法展开讲解，接下来主要讲一下CORS；</li>
</ul>
<h2 id="简单请求和非简单请求">简单请求和非简单请求</h2>
<p>浏览器将<strong>CORS跨域请求</strong>分为简单请求和非简单请求；</p>
<blockquote>
<p>如果你使用nginx反向代理解决的跨域问题，则不会有跨域请求这个说法了，因为nginx反向代理就使得前后端是同一个域了，就不存在跨域问题了。</p>
</blockquote>
<p>只要同时满足一下两个条件，就属于简单请求 (1)使用下列方法之一：</p>
<ul>
<li>head</li>
<li>get</li>
<li>post</li>
</ul>
<p>(2)请求的Heder是</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Content-Type: 只限于三个值：
<ul>
<li>application/x-www-form-urlencoded</li>
<li>multipart/form-data</li>
<li>text/plain</li>
</ul>
</li>
</ul>
<p>不同时满足上面的两个条件，就属于非简单请求。 浏览器对这两种的处理，是不一样的。</p>
<h2 id="简单请求">简单请求</h2>
<h3 id="例子">例子</h3>
<p>对于简单请求，浏览器直接发出CORS请求。具体来说，就是头信息之中，增加一个Origin字段。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/24/16b873283da2fb58?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="简单请求"></p>
<p>上面这个例子，<code>post``Content-Type``application/x-www-form-urlencoded``Access-Control-Allow-Origin: http://127.0.0.1:3000``Origin``Origin</code></p>
<h3 id="cors请求相关的字段都以-access-control-开头">CORS请求相关的字段，都以 <code>Access-Control-</code>开头</h3>
<ul>
<li>
<p>Access-Control-Allow-Origin</p>
<p>：必选</p>
<ul>
<li>请求头<code>Origin</code>字段的值</li>
<li><code>*</code>：接受任何域名</li>
</ul>
</li>
<li>
<p>Access-Control-Allow-Credentials</p>
<p>：可选，</p>
<ul>
<li>true: 表示允许发送cookie，此时<code>Access-Control-Allow-Origin</code>不能设置为<code>*</code>，必须指定明确的，与请求网页一致的域名。</li>
<li>不设置该字段：不需要浏览器发送cookie</li>
</ul>
</li>
<li>
<p>Access-Control-Expose-Headers</p>
<p>：可选</p>
<ul>
<li>响应报头指示哪些报头可以公开为通过列出他们的名字的响应的一部分。默认情况下，只显示6个简单的响应标头：
<ul>
<li>Cache-Control</li>
<li>Content-Language</li>
<li>Content-Type</li>
<li>Expires</li>
<li>Last-Modified</li>
<li>Pragma</li>
</ul>
</li>
<li>如果想要让客户端可以访问到其他的首部信息，可以将它们在 Access-Control-Expose-Headers 里面列出来。</li>
</ul>
</li>
</ul>
<h3 id="withcredentials-属性">withCredentials 属性</h3>
<p>CORS请求默认不发送Cookie和HTTP认证信息，如果要把Cookie发到服务器，一方面需要服务器同意，设置响应头<code>Access-Control-Allow-Credentials: true</code>,另一方面在客户端发出请求的时候也要进行一些设置;</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>// XHR</span></span>
<span class="line"><span>var xhr = new XMLHttpRequest();</span></span>
<span class="line"><span>xhr.open('GET', 'http://example.com/', true);</span></span>
<span class="line"><span>xhr.withCredentials = true;</span></span>
<span class="line"><span>xhr.send(null);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// Fetch</span></span>
<span class="line"><span>fetch(url, {</span></span>
<span class="line"><span>  credentials: 'include'</span></span>
<span class="line"><span>})</span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<h2 id="非简单请求">非简单请求</h2>
<p>非简单请求就是那种对服务器有特殊要求的请求，比如请求方法为<code>PUT</code>或<code>DELETE</code>，或者<code>Content-Type</code>字段为<code>application/json</code>;</p>
<h3 id="1-预检请求和回应">1. 预检请求和回应</h3>
<p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为“预检”请求； 浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段，只有得到肯定答复，浏览器才会发出正式的接口请求，否则就会报错；</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/24/16b873283c9ccfc8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="preflight"></p>
<p>HTTP请求的方法是POST，请求头<code>Content-Type</code>字段为<code>application/json</code>。浏览器发现，这是一个非简单请求，就自动发出一个<code>预检</code>请求，要求服务器确认可以这样请求。</p>
<h4 id="11预检请求">1.1预检请求</h4>
<p><code>预检</code>请求用的请求方法是OPTIONS，表示这个请求是用来询问的。头信息里面，关键字段是<code>Origin</code>，表示请求来自哪个域。 除了<code>Origin</code>，<code>预检</code>请求的头信息包括两个特殊字段：</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Request-Method">Access-Control-Request-Method</a>： 必选，用来列出浏览器的CORS请求会用到哪些HTTP方法，上例是<code>POST</code></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Request-Headers">Access-Control-Request-Headers</a>：该字段是一个用逗号分割的字符串，执行浏览器CORS请求会额外发送的头信息字段，上例是<code>Content-Type</code>;</li>
</ul>
<h4 id="12预检回应">1.2预检回应</h4>
<p>服务器收到<code>预检</code>请求以后，检查了<code>Origin</code>、<code>Access-Control-Request-Method</code>和<code>Access-Control-Request-Headers</code>字段以后，确认允许跨域请求，就可以做出回应。 上面的HTTP回应中，关键的是Access-Control-Allow-Origin字段，表示<a href="http://127.0.0.1:3000">http://127.0.0.1:3000</a>可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p>
<p>如果浏览器否定了“预检”请求，就会返回一个正常的HTTP回应，但是没有任何CORS相关的头信息字段，这时，浏览器就会认定，服务器不同意预检请求，因此触发一个错误，被XMLHttpRequest对象的onerror回调函数捕获h。</p>
<p>服务器回应的其他CORS字段</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods">Access-Control-Allow-Methods</a>：必需；它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的方法。这是为了避免多次<code>预检</code>请求。</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers">Access-Control-Allow-Headers</a>：如果浏览器请求头里包括<code>Access-Control-Request-Headers</code>字段，则<code>Access-Control-Allow-Headers</code>字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在<code>预检</code>中请求的字段。</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials">Access-Control-Allow-Credentials</a>：与简单请求时含义相同。</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Max-Age">Access-Control-Allow-Max-Age</a>: 可选，用来指定本次预检请求的有效期。单位为秒。在有效期内，不用发出另一条预检请求</li>
</ul>
<h3 id="2正常请求和回应">2.正常请求和回应</h3>
<p>一旦服务器通过了<code>预检</code>请求，以后每次浏览器正常的CORS请求，就都跟简单请求一样，会有一个<code>Origin</code>头信息字段。服务器的回应，也都会有一个<code>Access-Control-Allow-Origin</code>头信息字段；</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/24/16b873283cd30bd2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="normal"></p>
<h2 id="服务端如何设置cors">服务端如何设置CORS</h2>
<h2 id="单独接口单独处理">单独接口单独处理</h2>
<p>比如一个简单的登录页面，需要给接口接口传入 username和password 两个字段；前端的域名为 localhost:8900，后端的域名为 localhost:3200，构成跨域。</p>
<h3 id="1-如果设置请求头content-type-applicationx-www-form-urlencoded这种情况则为简单请求">1. 如果设置请求头<code>'Content-Type': 'application/x-www-form-urlencoded'</code>，这种情况则为简单请求</h3>
<p>会有跨域问题，直接设置 响应头 <code>Access-Control-Allow-Origin</code>为<code>*</code>, 或者具体的域名；注意如果设置响应头<code>Access-Control-Allow-Credentials</code>为<code>true</code>，表示要发送<code>cookie</code>，则此时<code>Access-Control-Allow-Origin</code>的值不能设置为星号，必须指定明确的，与请求网页一致的域名。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>const login = ctx => {</span></span>
<span class="line"><span>    const req = ctx.request.body;</span></span>
<span class="line"><span>    const userName = req.userName;</span></span>
<span class="line"><span>    ctx.set('Access-Control-Allow-Origin', '*');</span></span>
<span class="line"><span>    ctx.response.body = {</span></span>
<span class="line"><span>        data: {},</span></span>
<span class="line"><span>        msg: '登陆成功'</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<h3 id="2-如果设置请求头content-type-applicationjson这种情况则为非简单请求">2. 如果设置请求头<code>'Content-Type': 'application/json'</code>，这种情况则为非简单请求</h3>
<p>处理OPTIONS请求，服务端可以单独写一个路由，来处理<code>login</code>的OPTIONS的请求</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>app.use(route.options('/login', ctx => {</span></span>
<span class="line"><span>    ctx.set('Access-Control-Allow-Origin', '*');</span></span>
<span class="line"><span>    ctx.set('Access-Control-Allow-Headers', 'Content-Type');</span></span>
<span class="line"><span>    ctx.status = 204;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>}));</span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<p>大家都知道前端调用服务端的时候，会调用很多个接口，并且每个接口处理跨域请求的逻辑是完全一样的，我们可以把这部分抽离出来，作为一个中间件；</p>
<h2 id="写一个中间件进行处理">写一个中间件进行处理</h2>
<h3 id="首先了解一下koa中间件的洋葱圈模型">首先了解一下koa中间件的“洋葱圈”模型</h3>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/24/16b873283dddc80b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="洋葱圈"></p>
<p>将洋葱的一圈看做是一个中间件，直线型就是从第一个中间件走到最后一个，但是洋葱圈就很特殊了，最早use的中间件在洋葱最外层，开始的时候会按照顺序走到所有中间件，然后按照倒序再走一遍所有的中间件，相当于每个中间件都会进入两次，这就给了我们更多的操作空间。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>const Koa = require("koa");</span></span>
<span class="line"><span>const app = new Koa();</span></span>
<span class="line"><span>app.use((ctx, next) => {</span></span>
<span class="line"><span>    console.log('a - 1');</span></span>
<span class="line"><span>    next();</span></span>
<span class="line"><span>    console.log('a - 2');</span></span>
<span class="line"><span>})</span></span>
<span class="line"><span>app.use((ctx, next) => {</span></span>
<span class="line"><span>    console.log('b - 1');</span></span>
<span class="line"><span>    next();</span></span>
<span class="line"><span>    console.log('b - 2');</span></span>
<span class="line"><span>})</span></span>
<span class="line"><span>app.use((ctx, next) => {</span></span>
<span class="line"><span>    console.log('c - 1');</span></span>
<span class="line"><span>    next();</span></span>
<span class="line"><span>    console.log('c - 2');</span></span>
<span class="line"><span>})</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app.listen(3200, () => {</span></span>
<span class="line"><span>    console.log('启动成功');</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<p>输出</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>a - 1</span></span>
<span class="line"><span>b - 1</span></span>
<span class="line"><span>c - 1</span></span>
<span class="line"><span>c - 2</span></span>
<span class="line"><span>b - 2</span></span>
<span class="line"><span>a - 2</span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<p>Koa官方文档上把外层的中间件称为“上游”，内层的中间件为“下游”。 一般的中间件都会执行两次，调用<code>next</code>之前为一次，调用<code>next</code>时把控制按顺序传递给下游的中间件。当下游不再有中间件或者中间件没有执行 <code>next</code> 函数时，就将依次恢复上游中间件的行为，让上游中间件执行 <code>next</code>之后的代码；</p>
<h3 id="处理跨域的中间件简单示例">处理跨域的中间件简单示例</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>const Koa = require("koa");</span></span>
<span class="line"><span>const app = new Koa();</span></span>
<span class="line"><span>const route = require('koa-route');</span></span>
<span class="line"><span>var bodyParser = require('koa-bodyparser');</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app.use(bodyParser()); // 处理post请求的参数</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const login = ctx => {</span></span>
<span class="line"><span>    const req = ctx.request.body;</span></span>
<span class="line"><span>    const userName = req.userName;</span></span>
<span class="line"><span>    const expires = Date.now() + 3600000; // 设置超时时间为一小时后</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    var payload = {</span></span>
<span class="line"><span>        iss: userName,</span></span>
<span class="line"><span>        exp: expires</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>    const Token = jwt.encode(payload, secret);</span></span>
<span class="line"><span>    ctx.response.body = {</span></span>
<span class="line"><span>        data: Token,</span></span>
<span class="line"><span>        msg: '登陆成功'</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 将公共逻辑方法放到中间件中处理</span></span>
<span class="line"><span>app.use((ctx, next)=> {</span></span>
<span class="line"><span>    const headers = ctx.request.headers;</span></span>
<span class="line"><span>    if(ctx.method === 'OPTIONS') {</span></span>
<span class="line"><span>        ctx.set('Access-Control-Allow-Origin', '*');</span></span>
<span class="line"><span>        ctx.set('Access-Control-Allow-Headers', 'Authorization');</span></span>
<span class="line"><span>        ctx.status = 204;</span></span>
<span class="line"><span>    } else {</span></span>
<span class="line"><span>        next();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>})</span></span>
<span class="line"><span>app.use(route.post('/login', login));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>app.listen(3200, () => {</span></span>
<span class="line"><span>    console.log('启动成功');</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<p>上述<a href="https://github.com/funnycoderstar/demos/tree/master/koa/koa-cors">示例代码地址</a></p>
<h2 id="koacors是怎么实现的">@koa/cors是怎么实现的</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>'use strict';</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const vary = require('vary');</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * CORS middleware</span></span>
<span class="line"><span> *</span></span>
<span class="line"><span> * @param {Object} [options]</span></span>
<span class="line"><span> *  - {String|Function(ctx)} origin `Access-Control-Allow-Origin`, default is request Origin header</span></span>
<span class="line"><span> *  - {String|Array} allowMethods `Access-Control-Allow-Methods`, default is 'GET,HEAD,PUT,POST,DELETE,PATCH'</span></span>
<span class="line"><span> *  - {String|Array} exposeHeaders `Access-Control-Expose-Headers`</span></span>
<span class="line"><span> *  - {String|Array} allowHeaders `Access-Control-Allow-Headers`</span></span>
<span class="line"><span> *  - {String|Number} maxAge `Access-Control-Max-Age` in seconds</span></span>
<span class="line"><span> *  - {Boolean} credentials `Access-Control-Allow-Credentials`</span></span>
<span class="line"><span> *  - {Boolean} keepHeadersOnError Add set headers to `err.header` if an error is thrown</span></span>
<span class="line"><span> * @return {Function} cors middleware</span></span>
<span class="line"><span> * @api public</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>module.exports = function (options) {</span></span>
<span class="line"><span>    const defaults = {</span></span>
<span class="line"><span>        allowMethods: 'GET,HEAD,PUT,POST,DELETE,PATCH',</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>    // 默认的配置项和使用时设置的options进行一个融合</span></span>
<span class="line"><span>    options = Object.assign({}, defaults, options);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 因为函数的一些参数，exposeHeaders，allowMethods，allowHeaders的形式既可以是String,也可以是Array类型，</span></span>
<span class="line"><span>    // 如果是Array类型,也转换为用逗号分隔的字符串。</span></span>
<span class="line"><span>    if (Array.isArray(options.exposeHeaders)) {</span></span>
<span class="line"><span>        options.exposeHeaders = options.exposeHeaders.join(',');</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (Array.isArray(options.allowMethods)) {</span></span>
<span class="line"><span>        options.allowMethods = options.allowMethods.join(',');</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (Array.isArray(options.allowHeaders)) {</span></span>
<span class="line"><span>        options.allowHeaders = options.allowHeaders.join(',');</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (options.maxAge) {</span></span>
<span class="line"><span>        options.maxAge = String(options.maxAge);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    options.credentials = !!options.credentials;</span></span>
<span class="line"><span>    options.keepHeadersOnError = options.keepHeadersOnError === undefined || !!options.keepHeadersOnError;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    return async function cors(ctx, next) {</span></span>
<span class="line"><span>        // If the Origin header is not present terminate this set of steps.</span></span>
<span class="line"><span>        // The request is outside the scope of this specification.</span></span>
<span class="line"><span>        const requestOrigin = ctx.get('Origin');</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // Always set Vary header</span></span>
<span class="line"><span>        // https://github.com/rs/cors/issues/10</span></span>
<span class="line"><span>        ctx.vary('Origin');</span></span>
<span class="line"><span>        // 如果请求头不存在 origin，则直接跳出该中间件，执行下一个中间件</span></span>
<span class="line"><span>        if (!requestOrigin) return await next();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 对origin参数的不同类型做一个处理</span></span>
<span class="line"><span>        let origin;</span></span>
<span class="line"><span>        if (typeof options.origin === 'function') {</span></span>
<span class="line"><span>            origin = options.origin(ctx);</span></span>
<span class="line"><span>            if (origin instanceof Promise) origin = await origin;</span></span>
<span class="line"><span>            if (!origin) return await next();</span></span>
<span class="line"><span>        } else {</span></span>
<span class="line"><span>            origin = options.origin || requestOrigin;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        const headersSet = {};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        function set(key, value) {</span></span>
<span class="line"><span>            ctx.set(key, value);</span></span>
<span class="line"><span>            headersSet[key] = value;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        /**</span></span>
<span class="line"><span>        * 非OPTIONS请求的处理</span></span>
<span class="line"><span>        *</span></span>
<span class="line"><span>        */</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (ctx.method !== 'OPTIONS') {</span></span>
<span class="line"><span>            // Simple Cross-Origin Request, Actual Request, and Redirects</span></span>
<span class="line"><span>            set('Access-Control-Allow-Origin', origin);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (options.credentials === true) {</span></span>
<span class="line"><span>                set('Access-Control-Allow-Credentials', 'true');</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (options.exposeHeaders) {</span></span>
<span class="line"><span>                set('Access-Control-Expose-Headers', options.exposeHeaders);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (!options.keepHeadersOnError) {</span></span>
<span class="line"><span>                return await next();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            try {</span></span>
<span class="line"><span>                return await next();</span></span>
<span class="line"><span>            } catch (err) {</span></span>
<span class="line"><span>                const errHeadersSet = err.headers || {};</span></span>
<span class="line"><span>                const varyWithOrigin = vary.append(errHeadersSet.vary || errHeadersSet.Vary || '', 'Origin');</span></span>
<span class="line"><span>                delete errHeadersSet.Vary;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                err.headers = Object.assign({}, errHeadersSet, headersSet, {</span></span>
<span class="line"><span>                    vary: varyWithOrigin</span></span>
<span class="line"><span>                });</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                throw err;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } else {</span></span>
<span class="line"><span>            // Preflight Request</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            // If there is no Access-Control-Request-Method header or if parsing failed,</span></span>
<span class="line"><span>            // do not set any additional headers and terminate this set of steps.</span></span>
<span class="line"><span>            // The request is outside the scope of this specification.</span></span>
<span class="line"><span>            if (!ctx.get('Access-Control-Request-Method')) {</span></span>
<span class="line"><span>                // this not preflight request, ignore it</span></span>
<span class="line"><span>                return await next();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            ctx.set('Access-Control-Allow-Origin', origin);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (options.credentials === true) {</span></span>
<span class="line"><span>                ctx.set('Access-Control-Allow-Credentials', 'true');</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (options.maxAge) {</span></span>
<span class="line"><span>                ctx.set('Access-Control-Max-Age', options.maxAge);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (options.allowMethods) {</span></span>
<span class="line"><span>                ctx.set('Access-Control-Allow-Methods', options.allowMethods);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            let allowHeaders = options.allowHeaders;</span></span>
<span class="line"><span>            if (!allowHeaders) {</span></span>
<span class="line"><span>                allowHeaders = ctx.get('Access-Control-Request-Headers');</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            if (allowHeaders) {</span></span>
<span class="line"><span>                ctx.set('Access-Control-Allow-Headers', allowHeaders);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            ctx.status = 204;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span>复制代码</span></span></code></pre>
<p>以上是 <a href="https://github.com/koajs/cors/blob/master/index.js">@koa/cors</a> V3.0.0的源码实现，如果你真正理解的CORS，看源码的逻辑就会非常轻松。</p>
<p>主要是分两个逻辑来处理，有预检请求的和没有预检请求的。</p>
<p>对于非OPTIONS请求的处理，要根据情况加上 <code>Access-Control-Allow-Origin</code>，<code>Access-Control-Allow-Credentials</code>，<code>Access-Control-Expose-Headers</code>这三个响应头部；</p>
<p>对于OPTIONS请求（预检请求）的处理，要根据情况加上 <code>Access-Control-Allow-Origin</code>，<code>Access-Control-Allow-Credentials</code>，<code>Access-Control-Max-Age</code>，<code>Access-Control-Allow-Methods</code>，<code>Access-Control-Allow-Headers</code>这几个响应头部；</p> </div> <div id="cusdis_thread" class="mt-12" data-host="https://cusdis.com" data-app-id="c2b015f9-9a4b-4997-b66f-f9c6ca26ebdd" data-page-id="content/nodejs/koa-cross-domain.md" data-page-url="content/nodejs/koa-cross-domain.md" data-page-title="koa跨域" data-iframe="/js/cusdis/iframe.umd.js" data-style="/js/cusdis/style.css"></div> <script>
window.CUSDIS_LOCALE = {
  powered_by: '',
  post_comment: '发送',
  loading: '加载中...',
  // comment
  email: '邮箱(可选)',
  nickname: '昵称',
  reply_placeholder: '内容',
  reply_btn: '回复',
  sending: '发送中...',
  // reply
  mod_badge: '管理员',
  content_is_required: '内容不能为空',
  nickname_is_required: '昵称不能为空',
  comment_has_been_sent: '评论已发送, 管理员审核通过后会展示',
};
</script> <script async src="/js/cusdis/cusdis.min.js"></script>  </main> </body></html>