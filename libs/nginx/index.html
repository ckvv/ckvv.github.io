<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=theme-color content="#ffffff"><meta name=color-scheme content="light dark"><meta name=description content="安装nginx mac:
brew install nginx centos:
Install the prerequisites:
sudo yum install yum-utils [nginx-stable] name=nginx stable repo baseurl=http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck=1 enabled=1 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true [nginx-mainline] name=nginx mainline repo baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/ gpgcheck=1 enabled=0 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true By default, the repository for stable nginx packages is used. If you would like to use mainline nginx packages, run the following command:
sudo yum-config-manager --enable nginx-mainline To install nginx, run the following command:
sudo yum install nginx 其他安装方式"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx"><meta name=twitter:description content="安装nginx mac:
brew install nginx centos:
Install the prerequisites:
sudo yum install yum-utils [nginx-stable] name=nginx stable repo baseurl=http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck=1 enabled=1 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true [nginx-mainline] name=nginx mainline repo baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/ gpgcheck=1 enabled=0 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true By default, the repository for stable nginx packages is used. If you would like to use mainline nginx packages, run the following command:
sudo yum-config-manager --enable nginx-mainline To install nginx, run the following command:
sudo yum install nginx 其他安装方式"><meta property="og:title" content="Nginx"><meta property="og:description" content="安装nginx mac:
brew install nginx centos:
Install the prerequisites:
sudo yum install yum-utils [nginx-stable] name=nginx stable repo baseurl=http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck=1 enabled=1 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true [nginx-mainline] name=nginx mainline repo baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/ gpgcheck=1 enabled=0 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true By default, the repository for stable nginx packages is used. If you would like to use mainline nginx packages, run the following command:
sudo yum-config-manager --enable nginx-mainline To install nginx, run the following command:
sudo yum install nginx 其他安装方式"><meta property="og:type" content="article"><meta property="og:url" content="https://chenkai.life/libs/nginx/"><meta property="article:section" content="libs"><meta property="article:published_time" content="2021-07-09T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-25T19:31:20+08:00"><title>Nginx · CK's Blog</title><link rel=canonical href=https://chenkai.life/libs/nginx/><link rel=stylesheet href=/css/coder.min.0e0f0ac9929898ae6625ca3789e3f9e2e630ead0a5e0f1fe96c1ba7d8774342c.css integrity="sha256-Dg8KyZKYmK5mJco3ieP54uYw6tCl4PH+lsG6fYd0NCw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.d8f89ef09509afb63b9b2595ee174e53cc51ce02a6f6a2179e1621f9389e4340.css integrity="sha256-2Pie8JUJr7Y7myWV7hdOU8xRzgKm9qIXnhYh+TieQ0A=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/custom.min.56610f8c63ea4ca06cdac03f4fafe3e818c64566f988301b72895eb047082c51.css integrity="sha256-VmEPjGPqTKBs2sA/T6/j6BjGRWb5iDAbcolesEcILFE=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/favicon.ico><link rel=apple-touch-icon type=image/png sizes=256x256 href=/images/favicon-512x512.png><meta name=generator content="Hugo 0.101.0"><link rel=manifest href=/manifest.webmanifest></head><body class="preload-transitions colorscheme-auto"><div class=float-container><span id=dark-mode-toggle class=colorscheme-toggle><svg class="icon" aria-hidden="true"><use xlink:href="#icon-anheimoshi"/></svg></span></div><details id=table-of-contents-wapper><summary><svg class="icon" aria-hidden="true"><use xlink:href="#icon-caidan"/></svg></summary></details><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>CK's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><svg class="icon" aria-hidden="true"><use xlink:href="#icon-caidan"/></svg></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/>Home</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/marks/>Marks</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/ckvv/ckvv.github.io/new/main/content>Create</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item id=search-content><input class=search-int type=text placeholder=Search>
<button class=search-btn data-type=github>GitHub</button>
<button class=search-btn data-type=google>Google</button></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://chenkai.life/libs/nginx/>Nginx</a></h1><div class=edit-link style=float:right;color:#0366d6><a class=title rel=noopener target=_blank href=https://github.com/ckvv/ckvv.github.io/edit/main/content/libs/nginx.md>编辑</a></div></header><div class=post-meta><div class=date><span class=posted-on><svg class="icon" aria-hidden="true"><use xlink:href="#icon-date"/></svg><time datetime=2021-07-09T00:00:00Z>2021-07-09</time></span></div><div class=tags><svg class="icon" aria-hidden="true"><use xlink:href="#icon-biaoqian"/></svg><span class=tag><a href=/tags/tool/>Tool</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/nginx/>Nginx</a></span></div></div><h2 id=安装nginx>安装nginx
<a class=heading-link href=#%e5%ae%89%e8%a3%85nginx><i class="fa fa-link" aria-hidden=true></i></a></h2><p>mac:</p><pre tabindex=0><code>brew install nginx
</code></pre><p>centos:</p><p>Install the prerequisites:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install yum-utils
</span></span></code></pre></div><pre tabindex=0><code class=language-repo data-lang=repo>[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true

[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
</code></pre><p>By default, the repository for stable nginx packages is used. If you would like to use mainline nginx packages, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum-config-manager --enable nginx-mainline
</span></span></code></pre></div><p>To install nginx, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install nginx
</span></span></code></pre></div><p>其他安装方式</p><p>参考<a href=https://nginx.org/en/linux_packages.html>https://nginx.org/en/linux_packages.html</a></p><h2 id=nginx命令>Nginx命令
<a class=heading-link href=#nginx%e5%91%bd%e4%bb%a4><i class="fa fa-link" aria-hidden=true></i></a></h2><p><code>nginx -h</code>查看帮助</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -?,-h         : this help
</span></span><span style=display:flex><span>  -v            : show version and exit
</span></span><span style=display:flex><span>  -V            : show version and configure options <span style=color:#66d9ef>then</span> exit
</span></span><span style=display:flex><span>  -t            : test configuration and exit
</span></span><span style=display:flex><span>  -T            : test configuration, dump it and exit
</span></span><span style=display:flex><span>  -q            : suppress non-error messages during configuration testing
</span></span><span style=display:flex><span>  -s signal     : send signal to a master process: stop, quit, reopen, reload
</span></span><span style=display:flex><span>  -p prefix     : set prefix path <span style=color:#f92672>(</span>default: /usr/local/Cellar/nginx/1.17.3_1/<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -c filename   : set configuration file <span style=color:#f92672>(</span>default: /usr/local/etc/nginx/nginx.conf<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -g directives : set global directives out of configuration file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 启动 </span>
</span></span><span style=display:flex><span>nginx
</span></span><span style=display:flex><span><span style=color:#75715e>## 重启</span>
</span></span><span style=display:flex><span>nginx -s reload
</span></span><span style=display:flex><span><span style=color:#75715e>## 测试文件配置是否正确，查看配置文件位置</span>
</span></span><span style=display:flex><span>nginx -t
</span></span><span style=display:flex><span><span style=color:#75715e>## 要获取所有 running nginx 进程的列表，可以使用ps实用程序，例如</span>
</span></span><span style=display:flex><span>ps -ax | grep nginx
</span></span></code></pre></div><h2 id=nginx配置文件>nginx配置文件
<a class=heading-link href=#nginx%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...              <span style=color:#75715e>#全局块</span>
</span></span><span style=display:flex><span>events <span style=color:#f92672>{</span>         <span style=color:#75715e>#events块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>http      <span style=color:#75715e>#http块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ...   <span style=color:#75715e>#http全局块</span>
</span></span><span style=display:flex><span>    server        <span style=color:#75715e>#server块</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>        ...       <span style=color:#75715e>#server全局块</span>
</span></span><span style=display:flex><span>        location <span style=color:#f92672>[</span>PATTERN<span style=color:#f92672>]</span>   <span style=color:#75715e>#location块</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>        location <span style=color:#f92672>[</span>PATTERN<span style=color:#f92672>]</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    server
</span></span><span style=display:flex><span>    <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>    ...     <span style=color:#75715e>#http全局块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</li><li>events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li><li>http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li><li>server：配置虚拟主机的相关参数，一个http中可以有多个server。</li><li>location块：配置请求的路由，以及各种页面的处理情况。</li></ul><p>下面是一个配置文件例子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>########### 每个指令必须有分号结束。#################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#user administrator administrators;  #配置用户或者组，默认为nobody nobody。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#worker_processes 2;  #允许生成的进程数，默认为1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址</span>
</span></span><span style=display:flex><span>error_log log/error.log debug;  <span style=color:#75715e>#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>events <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    accept_mutex on;   <span style=color:#75715e>#设置网路连接序列化，防止惊群现象发生，默认为on</span>
</span></span><span style=display:flex><span>    multi_accept on;  <span style=color:#75715e>#设置一个进程是否同时接受多个网络连接，默认为off</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport</span>
</span></span><span style=display:flex><span>    worker_connections  1024;    <span style=color:#75715e>#最大连接数，默认为512</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    include       mime.types;   <span style=color:#75715e>#文件扩展名与文件类型映射表</span>
</span></span><span style=display:flex><span>    default_type  application/octet-stream; <span style=color:#75715e>#默认文件类型，默认为text/plain</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#access_log off; #取消服务日志    </span>
</span></span><span style=display:flex><span>    log_format myFormat <span style=color:#e6db74>&#39;$remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer    $http_user_agent $http_x_forwarded_for&#39;</span>; <span style=color:#75715e>#自定义格式</span>
</span></span><span style=display:flex><span>    access_log log/access.log myFormat;  <span style=color:#75715e>#combined为日志格式的默认值</span>
</span></span><span style=display:flex><span>    sendfile on;   <span style=color:#75715e>#允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span>
</span></span><span style=display:flex><span>    sendfile_max_chunk 100k;  <span style=color:#75715e>#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span>
</span></span><span style=display:flex><span>    keepalive_timeout 65;  <span style=color:#75715e>#连接超时时间，默认为75s，可以在http，server，location块。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    gzip on;
</span></span><span style=display:flex><span>    gzip_static on;
</span></span><span style=display:flex><span>    gzip_min_length 1024;
</span></span><span style=display:flex><span>    gzip_buffers <span style=color:#ae81ff>4</span> 16k;
</span></span><span style=display:flex><span>    gzip_comp_level 2;
</span></span><span style=display:flex><span>    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;
</span></span><span style=display:flex><span>    gzip_vary off;
</span></span><span style=display:flex><span>    gzip_disable <span style=color:#e6db74>&#34;MSIE [1-6]\.&#34;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    error_page <span style=color:#ae81ff>404</span> https://www.baidu.com; <span style=color:#75715e>#错误页</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    upstream mysvr <span style=color:#f92672>{</span>   
</span></span><span style=display:flex><span>      server 127.0.0.1:7878;
</span></span><span style=display:flex><span>      server 192.168.10.121:3333 backup;  <span style=color:#75715e>#热备</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        keepalive_requests 120; <span style=color:#75715e>#单连接请求上限次数。</span>
</span></span><span style=display:flex><span>        listen       4545;   <span style=color:#75715e>#监听端口</span>
</span></span><span style=display:flex><span>        server_name  127.0.0.1;   <span style=color:#75715e>#监听地址       </span>
</span></span><span style=display:flex><span>        location  ~*^.+$ <span style=color:#f92672>{</span>       <span style=color:#75715e>#请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#root path;  #根目录</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#alias</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#index vv.txt;  #设置默认页</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#proxy_pass  http://mysvr;  #请求转向mysvr 定义的服务器列表</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#deny 127.0.0.1;  #拒绝的ip</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#allow 172.18.5.54; #允许的ip           </span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=常见问题>常见问题
<a class=heading-link href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98><i class="fa fa-link" aria-hidden=true></i></a></h2><h3 id=nginx访问时报403>nginx访问时报403
<a class=heading-link href=#nginx%e8%ae%bf%e9%97%ae%e6%97%b6%e6%8a%a5403><i class="fa fa-link" aria-hidden=true></i></a></h3><p><code>ps aux | grep nginx</code></p><pre tabindex=0><code>root             66372   0.0  0.0  4300068   1584   ??  Ss   五06下午   0:00.10 nginx: master process nginx
nobody           20442   0.0  0.0  4300320   1272   ??  S     2:02下午   0:00.00 nginx: worker process
nobody           20441   0.0  0.0  4300320   1584   ??  S     2:02下午   0:00.00 nginx: worker process
nobody           20440   0.0  0.0  4300320   1332   ??  S     2:02下午   0:00.00 nginx: worker process
nobody           20439   0.0  0.0  4300320   1256   ??  S     2:02下午   0:00.00 nginx: worker process
</code></pre><p>由于启动用户和nginx工作用户不一致所致,将nginx.config的user改为和启动用户一致,修改nginx.config</p><pre tabindex=0><code>user root everyone;
</code></pre><ul><li>某些文件加载失败控制台<code>net::err_content_length_mismatch</code>，
查看日志文件发现类似下面错误</li></ul><pre tabindex=0><code>open() &#34;/usr/local/var/run/nginx/proxy_temp/1/04/0000000041&#34; failed (13: Permission denied) while reading upstream, client: 127.0.0.1,
</code></pre><p>查看当前nginx用户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> ps aux | grep <span style=color:#e6db74>&#34;nginx: worker process&#34;</span>
</span></span></code></pre></div><p>修改目录权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo chown -R youn_name /usr/local/var/run/nginx/proxy_temp
</span></span></code></pre></div><h3 id=http-重定向到https>http 重定向到https
<a class=heading-link href=#http-%e9%87%8d%e5%ae%9a%e5%90%91%e5%88%b0https><i class="fa fa-link" aria-hidden=true></i></a></h3><pre tabindex=0><code>if ($http_x_forwarded_proto = &#34;http&#34;) {
     return 301 https://$hostm$request_uri;
}
// 或者
if ($scheme = &#34;http&#34;) {
  return 301 https://$server_name$request_uri;
}
</code></pre><div id=cusdis_thread data-host=https://cusdis.com data-app-id=c2b015f9-9a4b-4997-b66f-f9c6ca26ebdd data-page-id=1962bfde819ad47f72edc8a27aebacc7 data-page-url=https://chenkai.life/libs/nginx/ data-page-title=Nginx data-iframe=/js/cusdis/iframe.umd.js data-style=/js/cusdis/style.css></div></article></section></div></main><script src=/js/coder.min.cb0c595e02234420f3ad3886bf4a9bd2874d0e1e78e090138a9ef158b35aaf17.js integrity="sha256-ywxZXgIjRCDzrTiGv0qb0odNDh544JATip7xWLNarxc="></script>
<script src=/js/custom.js></script>
<script src=/js/font.min.js></script></body><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js")</script></html>