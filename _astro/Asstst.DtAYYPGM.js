import{w as S}from"./runtime-dom.esm-bundler.BY0Bn5Jo.js";import{_ as E}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as A,u as D,o as i,c as u,a as h,r as j,b as H,w as M,F,e as C,f as g,g as y,h as P,t as k}from"./runtime-core.esm-bundler.DKSusNuW.js";async function z(t){const r=await t.arrayBuffer(),a=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}function L(t,r=1){const e=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(t)/Math.log(1024));return`${Number.parseFloat((t/1024**n).toFixed(r))} ${e[n]}`}function U(t){return["png","jpg","jpeg","gif","tif","tiff","svg"].includes(`${t.split(".").pop()}`)}async function w(t,r,a=6e3){const e=new AbortController,n=setTimeout(()=>e.abort(),a);return fetch(t,{...r,signal:e.signal}).then(o=>(clearTimeout(n),o)).catch(o=>{throw o.name==="AbortError"?new Error("Request timed out"):o})}const B={async upload(t){const r=(t.name.split(".").pop()||"").toLowerCase(),a=await z(t),e=new FormData;return e.append("file",t),(await w(`https://files.mapplat.com/${a}.${r}`,{method:"POST",body:e})).json()},async list(t){return(await w(`https://files.mapplat.com?${new URLSearchParams(t)}`)).json()},async del(t,r){return(await w(`https://files.mapplat.com/${t}`,{headers:new Headers({Authorization:r}),method:"DELETE"})).json()}},T=A({__name:"Upload",emits:["change"],setup(t,{expose:r,emit:a}){r();const e=a,n=D("input");function o(){n.value?.click()}function s(f){const m=f.target,_=m?.files;_?.length&&(e("change",_[0]),m.value="")}const p={emits:e,inputRef:n,onClick:o,onInput:s};return Object.defineProperty(p,"__isScriptSetup",{enumerable:!1,value:!0}),p}});function N(t,r,a,e,n,o){return i(),u("div",{onClick:e.onClick},[h("input",{ref:"input",type:"file",class:"hidden",onInput:e.onInput},null,544),j(t.$slots,"default")])}const I=E(T,[["render",N]]),x=20,R=A({__name:"Asstst",setup(t,{expose:r}){r();const a=y(!1),e=y(!1),n=y(!0),o=y(!1),s=y([]);async function p(c){try{o.value=!0;const l=await B.upload(c);s.value.push(l)}catch{}finally{o.value=!1}}async function f(){n.value=!0,a.value=!1,e.value=!1;try{const c={limit:x},l=s.value[s.value.length-1]?.key;l&&(c.startAfter=l);const d=await B.list(c);Array.isArray(d)&&(s.value=s.value.concat(d),d.length>=x&&(e.value=!0))}catch{a.value=!0,e.value=!1}finally{n.value=!1}}async function m(c,l,d,b){c.preventDefault();try{const v=prompt(b||"请输入密码");if(!v)return;if((await B.del(l.key,v))?.success===!1)return m(c,l,d,"密码错误, 请重新输入密码");s.value.splice(d,1)}catch{}}P(async()=>{f()});const _={limit:x,isHaveError:a,isHaveMore:e,isLoading:n,isUploading:o,files:s,onChange:p,search:f,handlerDel:m,get formatFileSize(){return L},get isPicture(){return U},Upload:I};return Object.defineProperty(_,"__isScriptSetup",{enumerable:!1,value:!0}),_}}),V={class:"flex flex-col gap-4"},$={class:"px-4 py-2 text-blue-500 bg-gray-100 rounded hover:text-blue-600"},O={class:"flex flex-wrap justify-center items-center gap-6"},q=["href"],G=["src","alt"],K={key:1,class:""},Y=["onClick"],Z={class:"select-none text-center cursor-pointer"},J={key:0},Q={key:3};function W(t,r,a,e,n,o){return i(),u("div",V,[H(e.Upload,{class:"self-end",onChange:e.onChange},{default:M(()=>[h("button",$,k(e.isUploading?"正在上传...":"上传"),1)]),_:1}),h("div",O,[(i(!0),u(F,null,C(e.files,(s,p)=>(i(),u("a",{key:s.key,href:`https://r2.mapplat.com/${s.key}`,target:"_blank",class:"group w-full md:w-52 md:h-52 p-2 hover:shadow-md cursor-pointer flex justify-center items-center !bg-gray-100 rounded relative"},[e.isPicture(s.key)?(i(),u("img",{key:0,class:"max-w-full max-h-full",src:`https://r2.mapplat.com/${s.key}`,alt:`.${s.key.split(".").pop()}(${e.formatFileSize(s.size)})`},null,8,G)):(i(),u("div",K,k(`.${s.key.split(".").pop()}`)+"("+k(e.formatFileSize(s.size))+") ",1)),h("div",{class:"w-8 h-8 justify-center items-center text-red-500 absolute top-0 right-0 hidden group-hover:flex text-xl hover:text-2xl",onClick:S(f=>e.handlerDel(f,s,p),["stop"])},"x",8,Y)],8,q))),128)),(i(),u(F,null,C(4,s=>h("div",{key:s,class:"w-52 h-0"})),64))]),h("div",Z,[e.isLoading?(i(),u("div",J," 加载中... ")):g("",!0),e.isHaveError?(i(),u("div",{key:1,onClick:e.search}," 加载失败(需要 VPN 访问), 点击重试 ")):g("",!0),e.isHaveMore?(i(),u("div",{key:2,onClick:e.search}," 加载更多 ")):g("",!0),!e.isHaveMore&&!e.isLoading&&!e.isHaveError?(i(),u("div",Q," --- 到底部了 --- ")):g("",!0)])])}const re=E(R,[["render",W]]);export{re as default};
